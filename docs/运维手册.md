# YesLocker 运维手册

## 📋 系统概览

YesLocker 是一个台球杆柜管理系统，包含以下组件：

- **用户端应用** (app.yes147.net) - H5移动端应用
- **管理端应用** (admin.yes147.net) - 管理后台
- **API服务** (api.yes147.net) - 后端服务
- **PostgreSQL数据库** - 数据存储

## 🚀 日常运维

### 1. 服务状态检查

#### Railway 控制台检查

1. 登录 [Railway Dashboard](https://railway.app)
2. 检查各服务状态（绿色 = 正常）
3. 查看资源使用情况（CPU、内存、网络）

#### API 健康检查

```bash
# 检查API服务状态
curl https://api.yes147.net/health

# 预期响应
{
  "status": "ok",
  "service": "YesLocker API (PostgreSQL)",
  "timestamp": "2025-01-05T10:00:00.000Z"
}
```

### 2. 日志查看

#### Railway 日志

在 Railway 控制台中：
1. 选择对应服务
2. 点击 "Logs" 标签
3. 可以实时查看或下载历史日志

#### 日志级别说明

- **INFO**: 正常操作日志
- **WARN**: 警告信息，需要关注
- **ERROR**: 错误信息，需要处理

### 3. 数据库维护

#### 备份数据库

```bash
# 连接到Railway数据库
export DATABASE_URL="postgresql://..."

# 备份数据
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql

# 备份特定表
pg_dump $DATABASE_URL -t users -t applications > users_backup.sql
```

#### 恢复数据库

```bash
# 恢复完整备份
psql $DATABASE_URL < backup.sql

# 恢复特定表
psql $DATABASE_URL < users_backup.sql
```

#### 常用数据库查询

```sql
-- 查看待处理申请数量
SELECT COUNT(*) FROM applications WHERE status = 'pending';

-- 查看活跃用户数
SELECT COUNT(*) FROM users WHERE created_at > NOW() - INTERVAL '30 days';

-- 查看杆柜使用率
SELECT 
  s.name as store_name,
  COUNT(l.id) as total_lockers,
  COUNT(CASE WHEN l.status = 'occupied' THEN 1 END) as occupied,
  ROUND(100.0 * COUNT(CASE WHEN l.status = 'occupied' THEN 1 END) / COUNT(l.id), 2) as usage_rate
FROM stores s
JOIN lockers l ON s.id = l.store_id
GROUP BY s.id, s.name;
```

## 🔧 常见问题处理

### 1. 服务无响应

**症状**：网站无法访问，显示 502/503 错误

**处理步骤**：
1. 检查 Railway 服务状态
2. 查看服务日志是否有错误
3. 重启服务：
   - 在 Railway 控制台选择服务
   - 点击 "Restart"
4. 检查数据库连接是否正常

### 2. 数据库连接失败

**症状**：API 报错 "Database connection error"

**处理步骤**：
1. 检查数据库服务是否运行
2. 验证 DATABASE_URL 环境变量
3. 检查数据库连接数是否超限
4. 重启 API 服务

### 3. 短信发送失败

**症状**：用户收不到验证码

**处理步骤**：
1. 检查腾讯云短信余额
2. 验证短信服务配置
3. 查看 API 日志中的短信发送记录
4. 检查短信模板是否被封

## 📊 性能优化

### 1. 数据库优化

```sql
-- 分析查询性能
EXPLAIN ANALYZE SELECT * FROM applications WHERE status = 'pending';

-- 更新统计信息
ANALYZE;

-- 清理死元组
VACUUM;
```

### 2. 缓存优化

- 考虑添加 Redis 缓存常用查询
- 设置合理的 HTTP 缓存头
- 使用 CDN 加速静态资源

### 3. 监控指标

重点监控：
- API 响应时间（< 200ms）
- 数据库查询时间（< 50ms）
- 错误率（< 0.1%）
- 并发用户数

## 🚨 应急响应

### 1. 服务降级方案

如果系统负载过高：
1. 暂停非核心功能（如统计报表）
2. 限制 API 请求频率
3. 启用静态页面缓存

### 2. 数据恢复流程

如果数据丢失：
1. 立即停止写入操作
2. 从最近的备份恢复
3. 检查数据完整性
4. 逐步恢复服务

### 3. 联系方式

- 技术负责人：[姓名] [电话]
- Railway 支持：support@railway.app
- 腾讯云支持：95716

## 📈 扩展计划

### 1. 水平扩展

当需要扩展时：
1. 在 Railway 增加服务实例数
2. 配置负载均衡
3. 考虑数据库读写分离

### 2. 垂直扩展

当需要更多资源时：
1. 升级 Railway 服务计划
2. 增加数据库规格
3. 优化代码性能

## 📝 维护清单

### 日常检查（每日）

- [ ] 检查服务运行状态
- [ ] 查看错误日志
- [ ] 监控资源使用率
- [ ] 检查待处理申请

### 定期维护（每周）

- [ ] 备份数据库
- [ ] 清理过期日志
- [ ] 更新依赖包（测试环境）
- [ ] 性能分析

### 深度维护（每月）

- [ ] 安全漏洞扫描
- [ ] 数据库优化
- [ ] 更新生产环境依赖
- [ ] 灾难恢复演练

## 🔐 安全建议

1. **定期更新**
   - 及时更新依赖包
   - 关注安全公告
   - 定期更换密钥

2. **访问控制**
   - 限制数据库访问IP
   - 使用强密码
   - 启用两步验证

3. **数据保护**
   - 加密敏感数据
   - 定期备份
   - 访问日志审计

## 📚 相关文档

- [部署指南](./GitHub-Railway部署指南.md)
- [环境变量配置](./环境变量配置指南.md)
- [API文档](./API文档.md)
- [数据库设计](../server/database/schema.sql)